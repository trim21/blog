<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
            --font-size: 17.5px;
        }
    </style>

    
    
    
    
    
    

    
    <title>bash和zsh的自动补全</title>
    <meta name="description" content="最近在给一个开源项目贡献代码,想要给他加上相应的自动补全功能
BGmi起初只是个 cli 程序,前端单纯的展示已经下载的剧集,后来给前端加了一些订阅功能,但是 cli 的使用频率还是很高,cli 没有自动补全功能总是说不过去,所以就花了一些时间加上了这个功能.
分析一下需求 BGmi 的命令都是同样的结构,bgmi …">
    <meta name="keywords" content='shell'>

    <meta property="og:url" content="https://blog.trim21.me/posts/bash-zsh-autocompltion/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="bash和zsh的自动补全">
    <meta property="og:description" content="最近在给一个开源项目贡献代码,想要给他加上相应的自动补全功能
BGmi起初只是个 cli 程序,前端单纯的展示已经下载的剧集,后来给前端加了一些订阅功能,但是 cli 的使用频率还是很高,cli 没有自动补全功能总是说不过去,所以就花了一些时间加上了这个功能.
分析一下需求 BGmi 的命令都是同样的结构,bgmi …">
    <meta property="og:image" content="https://blog.trim21.me/">
    <meta property="og:image:secure_url" content="https://blog.trim21.me/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="bash和zsh的自动补全">
    <meta name="twitter:description" content="最近在给一个开源项目贡献代码,想要给他加上相应的自动补全功能
BGmi起初只是个 cli 程序,前端单纯的展示已经下载的剧集,后来给前端加了一些订阅功能,但是 cli 的使用频率还是很高,cli 没有自动补全功能总是说不过去,所以就花了一些时间加上了这个功能.
分析一下需求 BGmi 的命令都是同样的结构,bgmi …">
    <meta property="twitter:domain" content="https://blog.trim21.me/posts/bash-zsh-autocompltion/">
    <meta property="twitter:url" content="https://blog.trim21.me/posts/bash-zsh-autocompltion/">
    <meta name="twitter:image" content="https://blog.trim21.me/">

    
    <link rel="canonical" href="https://blog.trim21.me/posts/bash-zsh-autocompltion/">

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.275fedb6f364c8865658bae576d82b514ace973f6a13ed63503a85b20c697453.js" integrity="sha256-J1/ttvNkyIZWWLrldtgrUUrOlz9qE&#43;1jUDqFsgxpdFM="></script>

    
    
</head>
<body>
        <script>
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        

        <div class="nav-title">
            <a class="nav-brand" href="https://blog.trim21.me/">Trim21&#39;s</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://blog.trim21.me/posts/" aria-label="" > Blog </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
                <a aria-hidden="true" role="switch">
                    <span class="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
                <a aria-checked="false" aria-labelledby="hamburger-menu-toggle" id="hamburger-menu-toggle-target" role="switch">
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://blog.trim21.me/posts/" > Blog </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
                    <a role="switch">
                        <span class="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>bash和zsh的自动补全</h1>

        

        
	
	
	
	
        

	

	

	
          <small role="doc-subtitle"></small>
	

	
          <p class="post-date">
              

              2017-12-09

              
                  | Updated 2025-03-03
              
          </p>
	

        <ul class="post-tags">
          
           
             <li class="post-tag"><a href="https://blog.trim21.me/tags/shell">shell</a></li>
           
         
        </ul>
    </div>

    <div class="post-content">
        <p>最近在给一个开源项目贡献代码,想要给他加上相应的自动补全功能</p>
<p><a href="https://github.com/BGmi/BGmi">BGmi</a>起初只是个 cli 程序,前端单纯的展示已经下载的剧集,后来给前端加了一些订阅功能,但是 cli 的使用频率还是很高,cli 没有自动补全功能总是说不过去,所以就花了一些时间加上了这个功能.</p>
<h2 id="分析一下需求">分析一下需求</h2>
<p>BGmi 的命令都是同样的结构,<code>bgmi action1 --opt1 arg1 --opt2 arg2</code>,那么我们需要补全的就是所有的 action 和每个 action 相应的选项了.在此之前,是直接<code>add_parser</code>和<code>add_argument</code>相应的 action 和选项.这样是没法进行下一步的,所以首先花了一些时间,所以首先把所有的<code>action</code>和相应的<code>opts</code>存在了一个变量中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>actions_and_arguments <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;action&#39;</span>: ACTION_ADD,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;help&#39;</span>: <span style="color:#e6db74">&#39;Subscribe bangumi.&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;arguments&#39;</span>: [
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#39;dest&#39;</span>: <span style="color:#e6db74">&#39;name&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;kwargs&#39;</span>: dict(metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;name&#39;</span>, type<span style="color:#f92672">=</span>unicode_, nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>,
</span></span><span style="display:flex;"><span>                            help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Bangumi name&#39;</span>), },
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#39;dest&#39;</span>: <span style="color:#e6db74">&#39;--episode&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;kwargs&#39;</span>: dict(metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;episode&#39;</span>,
</span></span><span style="display:flex;"><span>                            help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Add bangumi and mark it as specified episode.&#39;</span>,
</span></span><span style="display:flex;"><span>                            type<span style="color:#f92672">=</span>int), },
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;action&#39;</span>: ACTION_DELETE,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;help&#39;</span>: <span style="color:#e6db74">&#39;Unsubscribe bangumi.&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;arguments&#39;</span>: [
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#39;dest&#39;</span>: <span style="color:#e6db74">&#39;--name&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;kwargs&#39;</span>: dict(metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;name&#39;</span>, nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;+&#39;</span>, type<span style="color:#f92672">=</span>unicode_,
</span></span><span style="display:flex;"><span>                            help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Bangumi name to unsubscribe.&#39;</span>), },
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#39;dest&#39;</span>: <span style="color:#e6db74">&#39;--batch&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#39;kwargs&#39;</span>: dict(action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;No confirmation.&#39;</span>), },
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }]
</span></span></code></pre></div><p>一个<code>list</code>中储存了多个<code>dict</code>,每个<code>dict</code>对应一个<code>action</code>,每个<code>action</code>的选项存在<code>arguments</code>字段中.这里的命名可能有些混乱,写的时候没太注意.</p>
<p>无论是在 bash 还是 zsh 中,要让 bgmi 有自动补全的功能,都需要一个相应的函数来给 bgmi 命令提供自动补全功能,也就是说,我们是要把上面的一个<code>dict</code>转换成一个字符串. 这种事情,当然就该模板出马了.因为 BGmi 的 api 是由 tornado 提供的,所以就直接用<code>tornado.template</code>了.</p>
<h2 id="先从-bash-的自动补全开始">先从 Bash 的自动补全开始</h2>
<p>参考的<a href="https://segmentfault.com/a/1190000002968878">跟我一起写 shell 补全脚本（Bash 篇）</a></p>
<p>最终的模板<a href="https://github.com/BGmi/BGmi/blob/0b21db0148f1794219c96520151933904f2918cf/bgmi/others/_bgmi_completion_bash.sh">_bgmi_completion_bash.sh</a></p>
<h3 id="先说下-bash-的语法">先说下 bash 的语法</h3>
<p>基本上会用到的数据类型就是字符串和数字了,字符串两边需要加单引号的双引号,或者是反引号.而单引号和双引号还有一些不同.双引号允许转义,而单引号不允许</p>
<p>shell 的语法跟编程语言的语法有一些不同,感觉 shell 的语法在故意混淆字符串和命令.语句中的一个单词又可以做为命令又可以做为字符串.所以为了避免歧义,需要加上单引号或者双引号.而单引号和双引号又有一些不同.单引号是没有转义的,双引号是有转义的.比如说</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export var<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span>$var<span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># 1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span>$var<span style="color:#e6db74"> 233&#34;</span> <span style="color:#75715e"># 1 233</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;$var&#39;</span> <span style="color:#75715e"># $var</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;`ls`&#34;</span> <span style="color:#75715e"># 输出ls命令的输出</span>
</span></span></code></pre></div><p>在双引号字符串中,以<code>$</code>开头的会被替换成对应的变量,用反引号包起来的内容会视为命令,运行之后把输出替换为字符串的一部分</p>
<h3 id="然后是具体的代码">然后是具体的代码</h3>
<p>bash 用来提供自动补全的命令是<code>complete</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>complete --help
</span></span><span style="display:flex;"><span>complete: complete <span style="color:#f92672">[</span>-abcdefgjksuv<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-pr<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-DE<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-o option<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-A action<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-G globpat<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-W wordlist<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-F <span style="color:#66d9ef">function</span><span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-C command<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-X filterpat<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-P prefix<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-S suffix<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>name ...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Specify how arguments are to be completed by Readline.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    For each NAME, specify how arguments are to be completed.  If no options
</span></span><span style="display:flex;"><span>    are supplied, existing completion specifications are printed in a way that
</span></span><span style="display:flex;"><span>    allows them to be reused as input.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Options:
</span></span><span style="display:flex;"><span>      -p        print existing completion specifications in a reusable format
</span></span><span style="display:flex;"><span>      -r        remove a completion specification <span style="color:#66d9ef">for</span> each NAME, or, <span style="color:#66d9ef">if</span> no
</span></span><span style="display:flex;"><span>                NAMEs are supplied, all completion specifications
</span></span><span style="display:flex;"><span>      -D        apply the completions and actions as the default <span style="color:#66d9ef">for</span> commands
</span></span><span style="display:flex;"><span>                without any specific completion defined
</span></span><span style="display:flex;"><span>      -E        apply the completions and actions to <span style="color:#e6db74">&#34;empty&#34;</span> commands --
</span></span><span style="display:flex;"><span>                completion attempted on a blank line
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    When completion is attempted, the actions are applied in the order the
</span></span><span style="display:flex;"><span>    uppercase-letter options are listed above.  The -D option takes
</span></span><span style="display:flex;"><span>    precedence over -E.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Exit Status:
</span></span><span style="display:flex;"><span>    Returns success unless an invalid option is supplied or an error occurs.
</span></span></code></pre></div><p>本来<code>complete</code>是支持用另一个命令来进行自动补全的,但是试了试实在是太慢了,所以还是生成了一个 bash 函数.</p>
<p>因为我是编写了一个<code>_bgmi</code>函数来进行<code>bgmi</code>命令的自动补全,所以此处就应该<code>complete -F _bgmi bgmi</code></p>
<p>然后就是<code>_bgmi</code>函数本体了. config 太多,只贴了一部分.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>_bgmi<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local pre cur action
</span></span><span style="display:flex;"><span>    local actions bangumi config
</span></span><span style="display:flex;"><span>    actions<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;add delete update cal config filter fetch download list mark search source complete&#34;</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;BANGUMI_MOE_URL SAVE_PATH DOWNLOAD_DELEGATE MAX_PAGE TMP_PATH DANMAKU_API_URL&#34;</span>
</span></span><span style="display:flex;"><span>    COMPREPLY<span style="color:#f92672">=()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pre<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>COMP_WORDS[COMP_CWORD-1]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    cur<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>COMP_WORDS[COMP_CWORD]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $COMP_CWORD -eq <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$actions<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        action<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>COMP_WORDS[1]<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$action<span style="color:#e6db74">&#34;</span> in
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            update <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local opts
</span></span><span style="display:flex;"><span>            opts<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--download -d --not-ignore&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$opts<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            filter <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local opts
</span></span><span style="display:flex;"><span>            opts<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--subtitle --include --exclude --regex&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$opts<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            config <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$config<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            cal <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local opts
</span></span><span style="display:flex;"><span>            opts<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--today -f --force-update --download-cover --no-save&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$opts<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            source <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local source
</span></span><span style="display:flex;"><span>            source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bangumi_moe mikan_project dmhy&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$source<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            search <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local opts
</span></span><span style="display:flex;"><span>            opts<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--count --regex-filter --download --dupe&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$opts<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            download <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            local opts
</span></span><span style="display:flex;"><span>            opts<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--list --mark --status&#34;</span>
</span></span><span style="display:flex;"><span>            COMPREPLY<span style="color:#f92672">=(</span> <span style="color:#66d9ef">$(</span> compgen -W <span style="color:#e6db74">&#34;</span>$opts<span style="color:#e6db74">&#34;</span> -- $cur <span style="color:#66d9ef">)</span> <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">esac</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>complete -F _bgmi bgmi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># run `eval &#34;$(bgmi complete)&#34;` in your bash</span>
</span></span></code></pre></div><p><code>COMP_WORDS</code>是保存了当前命令行所有输入内容的一个数组,<code>COMP_CWORD</code>是当前正在输入的词的索引.
所以,<code>pre=${COMP_WORDS[COMP_CWORD-1]}</code>是当前正在输入的前一个词,<code>cur=${COMP_WORDS[COMP_CWORD]}</code>是正在输入的词.</p>
<p>(这里用<code>${}</code>包起来跟直接使用<code>$var</code>没有什么区别,只是其他语言的变量前不用加<code>$</code>,用<code>{}</code>包起来个人看起来习惯一点.)</p>
<p>因为<code>bgmi</code>的命令都是<code>bgmi action args</code>这样的形式,所以先判断<code>COMP_WORDS</code>的大小,如果等于 1,说明还没输出对应的 action,需要补全 action. 如果大于 1, 说明已经输入过了 action,只需要补全对应的选项.</p>
<p>在 bash 中,生成对应补全选项的命令是<code>compgen</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ compgen --help
</span></span><span style="display:flex;"><span>compgen: compgen <span style="color:#f92672">[</span>-abcdefgjksuv<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-o option<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-A action<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">[</span>-G globpat<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-W wordlist<span style="color:#f92672">]</span>  <span style="color:#f92672">[</span>-F <span style="color:#66d9ef">function</span><span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-C command<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">[</span>-X filterpat<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-P prefix<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-S suffix<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>word<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Display possible completions depending on the options.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Intended to be used from within a shell <span style="color:#66d9ef">function</span> generating possible
</span></span><span style="display:flex;"><span>    completions.  If the optional WORD argument is supplied, matches against
</span></span><span style="display:flex;"><span>    WORD are generated.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Exit Status:
</span></span><span style="display:flex;"><span>    Returns success unless an invalid option is supplied or an error occurs.
</span></span></code></pre></div><p>我在这里只用到了<code>compgen -W</code> 根据一个<code>wordlist</code>来生成对应的补全.</p>
<p>接下来只需要把对应的内容根据模板的要求进行修改就可以了.</p>
<h2 id="zsh-的自动补全">Zsh 的自动补全</h2>
<p>参照的这篇文章<a href="https://github.com/spacewander/blogWithMarkdown/issues/32">https://github.com/spacewander/blogWithMarkdown/issues/32</a></p>
<p>先放个结果&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>_bgmi<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">${#</span>words<span style="color:#e6db74">}</span> -le <span style="color:#ae81ff">2</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        _alternative <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            <span style="color:#e6db74">&#39;action:action options:((add\:&#34;Subscribe bangumi.&#34; delete\:&#34;Unsubscribe bangumi.&#34; list\:&#34;List subscribed bangumi.&#34; filter\:&#34;Set bangumi fetch filter.&#34; update\:&#34;Update bangumi calendar and subscribed bangumi episode.&#34; cal\:&#34;Print bangumi calendar.&#34; config\:&#34;Config BGmi.&#34; mark\:&#34;Mark bangumi episode.&#34; download\:&#34;Download manager.&#34; fetch\:&#34;Fetch bangumi.&#34; search\:&#34;Search torrents from data source by keyword&#34; source\:&#34;Select date source bangumi_moe or mikan_project&#34; install\:&#34;Install BGmi front / admin / download delegate&#34; upgrade\:&#34;Check update.&#34; history\:&#34;List your history of following bangumi&#34; ))&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">${</span>words[(i)cal]<span style="color:#e6db74">}</span> -le <span style="color:#e6db74">${#</span>words<span style="color:#e6db74">}</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        _alternative <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        <span style="color:#e6db74">&#39;cal:cal options:((--today\:&#34;Show bangumi calendar for today.&#34; -f\:&#34;Get the newest bangumi calendar from bangumi.moe.&#34; --force-update\:&#34;Get the newest bangumi calendar from bangumi.moe.&#34; --download-cover\:&#34;Download the cover to local&#34; --no-save\:&#34;Do not save the bangumi data when force update.&#34; ))&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compdef _bgmi bgmi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#usage: eval &#34;$(bgmi complete)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if you are using windows, cygwin or babun, try `eval &#34;$(bgmi complete|dos2unix)&#34;`</span>
</span></span></code></pre></div><p>zsh 跟 bash 有几点不同</p>
<p>bash 中的 complete 在 zsh 中是 compdef</p>
<p>zsh 中用来保存目前所有输入的词组是<code>words</code></p>
<p>zsh 中要生成对应的提醒的话用的是<code>_alternative</code>等命令,而不是把结果赋值给某个变量.</p>
<p>其中有这样一个用法</p>
<p><code>${words[(i)cal]}</code> 这类似于 js 中的<code>words.indexOf('cal')</code> 而<code>#a</code>就相当于<code>a.length</code></p>
<p>因为<code>_alternative</code>的功能是最全的,所以我就只用了<code>_alternative</code>这一个命令
<code>cal:cal options:(( -f\:&quot;Get the newest bangumi calendar from bangumi.moe.&quot; --force-update\:&quot;Get the newest bangumi calendar from bangumi.moe.&quot; ))</code></p>
<p>如果有两个选项是同样的意思,直接重复输出就可以了,zsh 会自动把他们合并成一行,就像这样 其中 <code>--force-update</code>和<code>-f</code>的帮助信息在我们输入的时候就是相同的.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>ubuntu@VM-189-243-ubuntu ~ $ bgmi cal -
</span></span><span style="display:flex;"><span>--download-cover      -- Download the cover to local
</span></span><span style="display:flex;"><span>--force-update    -f  -- Get the newest bangumi calendar from bangumi.moe.
</span></span><span style="display:flex;"><span>--no-save             -- Do not save the bangumi data when force update.
</span></span><span style="display:flex;"><span>--today               -- Show bangumi calendar <span style="color:#66d9ef">for</span> today.
</span></span></code></pre></div>
        
    </div>

    <div class="prev-next">
        
    </div>

    
    
    
    <div id="comments">
        <script src="https://utteranc.es/client.js"
    repo="trim21/blog"
    issue-term="title"
    crossorigin="anonymous"
    async></script>

    </div>
    
</div>



    

        </main><footer class="footer">
    
    

    

    

    

    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/gokarna-theme/gokarna-hugo">Gokarna</a>
    </span>
</footer>
</body>
</html>
