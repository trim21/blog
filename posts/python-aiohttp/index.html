<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>基于asyncio的web框架aiohttp | Trim21&#39;s</title>
<meta name="keywords" content="python">
<meta name="description" content="本来想扯一通标准库里添加了asyncio的意义, 什么统一了异步框架, 什么方便代码前移之类的了.
然后发现原来大家也都是用装饰器&#43;生成器来写的, 好像也没啥区别&hellip;
迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, asyncio成为标准库也改变不了这一点.
不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了
在 3.4 就是上面说的, 引入了asyncio的标准库.
3.5 有了一系列的 bug fix ,可以见why-is-python-3-5-3-the-lowest-supported-version, 还支持了async/await语法.
不过 3.5 的时候async/await还不是关键字, 还可以给async赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了async当变量&hellip;
import asyncio
import sys

print(sys.version_info) # 3.5.4


async def hello():
    print(&#34;Hello world!&#34;)
    # 异步调用asyncio.sleep(1):
    r = await asyncio.sleep(1)
    print(&#34;Hello again!&#34;)


async = 1
print(async)

# 获取EventLoop:
loop = asyncio.get_event_loop()
# 执行coroutine
loop.run_until_complete(hello())
loop.close()
会输出
1
Hello world!
Hello again!
但是如果到了 python3.7, 会报错SyntaxError, 也因为这个原因挂了一堆库.">
<meta name="author" content="">
<link rel="canonical" href="https://blog.trim21.me/posts/python-aiohttp/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.trim21.me/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.trim21.me/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.trim21.me/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.trim21.me/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.trim21.me/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.trim21.me/posts/python-aiohttp/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://blog.trim21.me/posts/python-aiohttp/">
  <meta property="og:site_name" content="Trim21&#39;s">
  <meta property="og:title" content="基于asyncio的web框架aiohttp">
  <meta property="og:description" content="本来想扯一通标准库里添加了asyncio的意义, 什么统一了异步框架, 什么方便代码前移之类的了. 然后发现原来大家也都是用装饰器&#43;生成器来写的, 好像也没啥区别…
迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, asyncio成为标准库也改变不了这一点.
不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了
在 3.4 就是上面说的, 引入了asyncio的标准库.
3.5 有了一系列的 bug fix ,可以见why-is-python-3-5-3-the-lowest-supported-version, 还支持了async/await语法.
不过 3.5 的时候async/await还不是关键字, 还可以给async赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了async当变量…
import asyncio import sys print(sys.version_info) # 3.5.4 async def hello(): print(&#34;Hello world!&#34;) # 异步调用asyncio.sleep(1): r = await asyncio.sleep(1) print(&#34;Hello again!&#34;) async = 1 print(async) # 获取EventLoop: loop = asyncio.get_event_loop() # 执行coroutine loop.run_until_complete(hello()) loop.close() 会输出
1 Hello world! Hello again! 但是如果到了 python3.7, 会报错SyntaxError, 也因为这个原因挂了一堆库.">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-10-05T17:42:21+08:00">
    <meta property="article:modified_time" content="2025-03-03T05:55:21+08:00">
    <meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于asyncio的web框架aiohttp">
<meta name="twitter:description" content="本来想扯一通标准库里添加了asyncio的意义, 什么统一了异步框架, 什么方便代码前移之类的了.
然后发现原来大家也都是用装饰器&#43;生成器来写的, 好像也没啥区别&hellip;
迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, asyncio成为标准库也改变不了这一点.
不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了
在 3.4 就是上面说的, 引入了asyncio的标准库.
3.5 有了一系列的 bug fix ,可以见why-is-python-3-5-3-the-lowest-supported-version, 还支持了async/await语法.
不过 3.5 的时候async/await还不是关键字, 还可以给async赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了async当变量&hellip;
import asyncio
import sys

print(sys.version_info) # 3.5.4


async def hello():
    print(&#34;Hello world!&#34;)
    # 异步调用asyncio.sleep(1):
    r = await asyncio.sleep(1)
    print(&#34;Hello again!&#34;)


async = 1
print(async)

# 获取EventLoop:
loop = asyncio.get_event_loop()
# 执行coroutine
loop.run_until_complete(hello())
loop.close()
会输出
1
Hello world!
Hello again!
但是如果到了 python3.7, 会报错SyntaxError, 也因为这个原因挂了一堆库.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "posts",
      "item": "https://blog.trim21.me/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "基于asyncio的web框架aiohttp",
      "item": "https://blog.trim21.me/posts/python-aiohttp/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于asyncio的web框架aiohttp",
  "name": "基于asyncio的web框架aiohttp",
  "description": "本来想扯一通标准库里添加了asyncio的意义, 什么统一了异步框架, 什么方便代码前移之类的了. 然后发现原来大家也都是用装饰器+生成器来写的, 好像也没啥区别\u0026hellip;\n迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, asyncio成为标准库也改变不了这一点.\n不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了\n在 3.4 就是上面说的, 引入了asyncio的标准库.\n3.5 有了一系列的 bug fix ,可以见why-is-python-3-5-3-the-lowest-supported-version, 还支持了async/await语法.\n不过 3.5 的时候async/await还不是关键字, 还可以给async赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了async当变量\u0026hellip;\nimport asyncio import sys print(sys.version_info) # 3.5.4 async def hello(): print(\u0026#34;Hello world!\u0026#34;) # 异步调用asyncio.sleep(1): r = await asyncio.sleep(1) print(\u0026#34;Hello again!\u0026#34;) async = 1 print(async) # 获取EventLoop: loop = asyncio.get_event_loop() # 执行coroutine loop.run_until_complete(hello()) loop.close() 会输出\n1 Hello world! Hello again! 但是如果到了 python3.7, 会报错SyntaxError, 也因为这个原因挂了一堆库.\n",
  "keywords": [
    "python"
  ],
  "articleBody": "本来想扯一通标准库里添加了asyncio的意义, 什么统一了异步框架, 什么方便代码前移之类的了. 然后发现原来大家也都是用装饰器+生成器来写的, 好像也没啥区别…\n迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, asyncio成为标准库也改变不了这一点.\n不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了\n在 3.4 就是上面说的, 引入了asyncio的标准库.\n3.5 有了一系列的 bug fix ,可以见why-is-python-3-5-3-the-lowest-supported-version, 还支持了async/await语法.\n不过 3.5 的时候async/await还不是关键字, 还可以给async赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了async当变量…\nimport asyncio import sys print(sys.version_info) # 3.5.4 async def hello(): print(\"Hello world!\") # 异步调用asyncio.sleep(1): r = await asyncio.sleep(1) print(\"Hello again!\") async = 1 print(async) # 获取EventLoop: loop = asyncio.get_event_loop() # 执行coroutine loop.run_until_complete(hello()) loop.close() 会输出\n1 Hello world! Hello again! 但是如果到了 python3.7, 会报错SyntaxError, 也因为这个原因挂了一堆库.\nFile \"app.py\", line 14 async = 1 ^ SyntaxError: invalid syntax 比如说 twisted, python3.7.0 是 6 月 27 号发布的, 但是直到到前两天(2018-10-05), pypi 上的最新版本还不能正常运行…\n说了半天没用的…\n最近在折腾的 python 框架 aiohttp 其实没有这个问题. 因为 aiohttp3.x.x 的最低版本要求就是 3.5.4, 从一开始就用到了async/await, 自然也不会有某个开发者把 async 再当作函数参数或者变量来赋值.\n出于好奇, 还是了解了一下 aiohttp 这个框架, 写了几个小玩具.\nfrom aiohttp import web import asyncio route = web.RouteTableDef() async def index(request): await asyncio.sleep(1) return web.Response(text='hello world') @route.get('/about') async def about(request): return web.Response(text=request.app.version + ' author Trim21') @web.middleware async def middleware(request, handler): # before handle request resp = await handler(request) return resp def create_app(): app = web.Application(middlewares=[middleware, ]) app.version = '0.0.1' app.add_routes([ web.get('/', index, name='index'), ]) app.add_routes(route) return app web.run_app(create_app()) 一个简单的例子, (如果需要数据库的话, 官方的例子是把 mongo 的连接池绑在了app.mongo上.)\n前面提到了, 语言层面的异步支持是越来越好了, 但是类库的支持还是有些匮乏.\nmongodb 和 redis 的支持还算可以, mongodb 的官方自己写了motor, aiohttp 的开发者写了aioredis.\n但是如果想找一个异步的关系型数据库的 ORM 就非常难了. SQLAlchemy 的作者曾经写过一篇文章, 说因为 python 本身就很慢, 所以异步也没有意义, 反而比同步还要慢.\n但我还是相信 python, 会有那么一天变快的(\n异步的 SQL ORM 主要有这么几个\npeewee-async gino gino直接 pass, 因为目前只支持 postgreSQL.\npeewee-async的问题是, 他其实是基于 peewee 的, 你要通过 peewee 来定义你的模块, 然后用peewee-async给的一个Manager来异步调用.\n举个例子, 他的异步代码是长这样的\nimport peewee from peewee_async import Manager, PostgresqlDatabase class User(peewee.Model): username = peewee.CharField(max_length=40, unique=True) class Twitter(peewee.Model): user = peewee.ForeignKeyField(model=User, backref='tweets') objects = Manager(PostgresqlDatabase('test')) objects.database.allow_sync = False # this will raise AssertionError on ANY sync call async def my_async_func(): user0 = await objects.create(User, username='test') user1 = await objects.get(User, id=user0.id) user2 = await objects.get(User, username='test') # All should be the same print(user0.id, user1.id, user2.id) print(user0.tweets) # raise exception here 像这个例子比较简单, 就只有一个外键, 还添加了backref, 就容易出问题了.\n因为本身是异步框架, 所以同步的代码都会阻塞整个事件循环, 在使用 orm 的时候会先设置禁止同步链接数据库, 只允许异步链接. 但是如果用了外键, peewee 在你试图获取对应的属性的时候就会链接数据库, 取回对应的数据. 所以如果用了外键, 在查询和使用实例的时候总要小心翼翼的, 以避免触发同步查询.\n也许不用外键, 直接存 id 进去, 不依赖数据库的约束, 而在 web 层面约束可能好一些, 不会出现类似的问题.\nORM 扯完了, 几个经常会用到的东西.\n模板: aiohttp-jinja2\nsession: aiohttp-session\n辅助的开发服务器, 支持 livereload 和 hotreloadaiohttp-devtools\ndevtools 有一些坑, 主要是项目的 readme 不是很全, 主要还是要靠 cli 的 help 信息和源码…\n比如, 我的项目结构是这样的\nproject ├─ Dockerfile ├─ README.md ├─ requirements.txt └──app ├─ main.py ├─static │ └─css │ └── 1.css └──templates └── index.html 这里有一个潜在的坑, 如果你要在project目录下直接启动服务器的话, 是不能提供app-path的, 而是用通过--root来启动, 比如说adev runserver --root app\n但是如果你的pwd是app, 此时不需要提供root-path, 只需要提供app-apth, 启动命令变为adev runserver main.py\n贴一下runserver的 help 信息\nUsage: adev runserver [OPTIONS] [APP_PATH] Run a development server for an aiohttp apps. Takes one argument \"app-path\" which should be a path to either a directory containing a recognized default file (\"app.py\" or \"main.py\") or to a specific file. Defaults to the environment variable \"AIO_APP_PATH\" or \".\". The app path is run directly, see the \"--app-factory\" option for details on how an app is loaded from a python module. Options: -s, --static DIRECTORY Path of static files to serve, if excluded static files aren't served. env variable: AIO_STATIC_STATIC --root DIRECTORY Root directory project used to qualify other paths. env variable: AIO_ROOT --static-url TEXT URL path to serve static files from, default \"/static/\". env variable: AIO_STATIC_URL --livereload / --no-livereload Whether to inject livereload.js into html page footers to autoreload on changes. env variable AIO_LIVERELOAD --host TEXT host used when referencing livereload and static files, if blank host is taken from the request header with default of localhost. env variable AIO_HOST --debug-toolbar / --no-debug-toolbar Whether to enable debug toolbar. env variable: AIO_DEBUG_TOOLBAR --app-factory TEXT name of the app factory to create an aiohttp.web.Application with, if missing default app-factory names are tried. This can be either a function with signature \"def create_app(loop): -\u003e Application\" or \"def create_app(): -\u003e Application\" or just an instance of aiohttp.Application. env variable AIO_APP_FACTORY -p, --port INTEGER Port to serve app from, default 8000. env variable: AIO_PORT --aux-port INTEGER Port to serve auxiliary app (reload and static) on, default port + 1. env variable: AIO_AUX_PORT -v, --verbose Enable verbose output. --help Show this message and exit. 其中, -s, --static因为实际上静态文件要通过--aux-port去访问, 所以感觉有些鸡肋.\n也就是说, 如果正常的服务器启动在6001端口, 而aux-server启动在6002端口, 我们要使用这个参数代理的静态文件的话, 要访问http://localhost:6002/static/1.css, 而正常我们会把静态文件放在同一个域名下, 也就是http://localhost:6001/static/1.css, 所以我的选择是直接添加一个web.static的路由, 而不是使用的这个功能.\n",
  "wordCount" : "647",
  "inLanguage": "en",
  "datePublished": "2018-10-05T17:42:21+08:00",
  "dateModified": "2025-03-03T05:55:21+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.trim21.me/posts/python-aiohttp/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Trim21's",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.trim21.me/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.trim21.me/" accesskey="h" title="Trim21&#39;s (Alt + H)">Trim21&#39;s</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.trim21.me/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      基于asyncio的web框架aiohttp
    </h1>
    <div class="post-meta"><span title='2018-10-05 17:42:21 +0800 +0800'>2018-10-05</span>

</div>
  </header> 
  <div class="post-content"><p>本来想扯一通标准库里添加了<code>asyncio</code>的意义, 什么统一了异步框架, 什么方便代码前移之类的了.
然后发现原来大家也都是用装饰器+生成器来写的, 好像也没啥区别&hellip;</p>
<p>迁移的主要阻力也不是各个框架实现异步的方式不同, 而是用到了框架的某些特性, 在其他框架里可能没有, <code>asyncio</code>成为标准库也改变不了这一点.</p>
<p>不过 python3.4 3.5 3.6 添加了很多新功能,语言层面的异步支持越来越好了</p>
<p>在 3.4 就是上面说的, 引入了<code>asyncio</code>的标准库.</p>
<p>3.5 有了一系列的 bug fix ,可以见<a href="https://aiohttp.readthedocs.io/en/stable/faq.html#why-is-python-3-5-3-the-lowest-supported-version">why-is-python-3-5-3-the-lowest-supported-version</a>, 还支持了<code>async/await</code>语法.</p>
<p>不过 3.5 的时候<code>async/await</code>还不是关键字, 还可以给<code>async</code>赋值, 所以到了 python3.7 的时候挂了一堆库, 因为他们用了<code>async</code>当变量&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(sys<span style="color:#f92672">.</span>version_info) <span style="color:#75715e"># 3.5.4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Hello world!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 异步调用asyncio.sleep(1):</span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Hello again!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#66d9ef">async</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取EventLoop:</span>
</span></span><span style="display:flex;"><span>loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行coroutine</span>
</span></span><span style="display:flex;"><span>loop<span style="color:#f92672">.</span>run_until_complete(hello())
</span></span><span style="display:flex;"><span>loop<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>会输出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Hello world!
</span></span><span style="display:flex;"><span>Hello again!
</span></span></code></pre></div><p>但是如果到了 python3.7, 会报错<code>SyntaxError</code>, 也因为这个原因挂了一堆库.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;app.py&#34;</span>, line <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>    async <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          ^
</span></span><span style="display:flex;"><span>SyntaxError: invalid syntax
</span></span></code></pre></div><p>比如说 twisted, python3.7.0 是 6 月 27 号发布的, 但是直到到前两天(2018-10-05), pypi 上的最新版本还不能正常运行&hellip;</p>
<p>说了半天没用的&hellip;</p>
<p>最近在折腾的 python 框架 aiohttp 其实没有这个问题. 因为 aiohttp3.x.x 的最低版本要求就是 3.5.4, 从一开始就用到了<code>async/await</code>, 自然也不会有某个开发者把 async 再当作函数参数或者变量来赋值.</p>
<p>出于好奇, 还是了解了一下 aiohttp 这个框架, 写了几个小玩具.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> web
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>route <span style="color:#f92672">=</span> web<span style="color:#f92672">.</span>RouteTableDef()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> web<span style="color:#f92672">.</span>Response(text<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hello world&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route.get</span>(<span style="color:#e6db74">&#39;/about&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">about</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> web<span style="color:#f92672">.</span>Response(text<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>version <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; author Trim21&lt;trim21me@gmail.com&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@web.middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">middleware</span>(request, handler):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># before handle request</span>
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> handler(request)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_app</span>():
</span></span><span style="display:flex;"><span>    app <span style="color:#f92672">=</span> web<span style="color:#f92672">.</span>Application(middlewares<span style="color:#f92672">=</span>[middleware, ])
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>add_routes([
</span></span><span style="display:flex;"><span>        web<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;/&#39;</span>, index, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;index&#39;</span>),
</span></span><span style="display:flex;"><span>    ])
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>add_routes(route)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>web<span style="color:#f92672">.</span>run_app(create_app())
</span></span></code></pre></div><p>一个简单的例子, (如果需要数据库的话, 官方的例子是把 mongo 的连接池绑在了<code>app.mongo</code>上.)</p>
<p>前面提到了, 语言层面的异步支持是越来越好了, 但是类库的支持还是有些匮乏.</p>
<p>mongodb 和 redis 的支持还算可以, mongodb 的官方自己写了<a href="https://github.com/mongodb/motor"><code>motor</code></a>, aiohttp 的开发者写了<a href="https://github.com/aio-libs/aioredis"><code>aioredis</code></a>.</p>
<p>但是如果想找一个异步的关系型数据库的 ORM 就非常难了. <a href="http://techspot.zzzeek.org/2015/02/15/asynchronous-python-and-databases/">SQLAlchemy 的作者曾经写过一篇文章</a>, 说因为 python 本身就很慢, 所以异步也没有意义, 反而比同步还要慢.</p>
<p><del>但我还是相信 python, 会有那么一天变快的(</del></p>
<p>异步的 SQL ORM 主要有这么几个</p>
<ol>
<li><a href="https://github.com/05bit/peewee-async"><code>peewee-async</code></a></li>
<li><a href="https://github.com/fantix/gino"><code>gino</code></a></li>
</ol>
<p><code>gino</code>直接 pass, 因为目前只支持 postgreSQL.</p>
<p><code>peewee-async</code>的问题是, 他其实是基于 peewee 的, 你要通过 peewee 来定义你的模块, 然后用<code>peewee-async</code>给的一个<code>Manager</code>来异步调用.</p>
<p>举个例子, 他的异步代码是长这样的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> peewee
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> peewee_async <span style="color:#f92672">import</span> Manager, PostgresqlDatabase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(peewee<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> peewee<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">40</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Twitter</span>(peewee<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> peewee<span style="color:#f92672">.</span>ForeignKeyField(model<span style="color:#f92672">=</span>User, backref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tweets&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objects <span style="color:#f92672">=</span> Manager(PostgresqlDatabase(<span style="color:#e6db74">&#39;test&#39;</span>))
</span></span><span style="display:flex;"><span>objects<span style="color:#f92672">.</span>database<span style="color:#f92672">.</span>allow_sync <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># this will raise AssertionError on ANY sync call</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_async_func</span>():
</span></span><span style="display:flex;"><span>    user0 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> objects<span style="color:#f92672">.</span>create(User, username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>)
</span></span><span style="display:flex;"><span>    user1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> objects<span style="color:#f92672">.</span>get(User, id<span style="color:#f92672">=</span>user0<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>    user2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> objects<span style="color:#f92672">.</span>get(User, username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># All should be the same</span>
</span></span><span style="display:flex;"><span>    print(user0<span style="color:#f92672">.</span>id, user1<span style="color:#f92672">.</span>id, user2<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>    print(user0<span style="color:#f92672">.</span>tweets)  <span style="color:#75715e"># raise exception here</span>
</span></span></code></pre></div><p>像这个例子比较简单, 就只有一个外键, 还添加了<code>backref</code>, 就容易出问题了.</p>
<p>因为本身是异步框架, 所以同步的代码都会阻塞整个事件循环, 在使用 orm 的时候会先设置禁止同步链接数据库, 只允许异步链接. 但是如果用了外键, peewee 在你试图获取对应的属性的时候就会链接数据库, 取回对应的数据. 所以如果用了外键, 在查询和使用实例的时候总要小心翼翼的, 以避免触发同步查询.</p>
<p>也许不用外键, 直接存 id 进去, 不依赖数据库的约束, 而在 web 层面约束可能好一些, 不会出现类似的问题.</p>
<p>ORM 扯完了, 几个经常会用到的东西.</p>
<p>模板: <a href="https://github.com/aio-libs/aiohttp-jinja2"><code>aiohttp-jinja2</code></a></p>
<p>session: <a href="https://github.com/aio-libs/aiohttp-session"><code>aiohttp-session</code></a></p>
<p>辅助的开发服务器, 支持 livereload 和 hotreload<a href="https://github.com/aio-libs/aiohttp-devtools"><code>aiohttp-devtools</code></a></p>
<p>devtools 有一些坑, 主要是项目的 readme 不是很全, 主要还是要靠 cli 的 help 信息和源码&hellip;</p>
<p>比如, 我的项目结构是这样的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>project
</span></span><span style="display:flex;"><span>├─ Dockerfile
</span></span><span style="display:flex;"><span>├─ README.md
</span></span><span style="display:flex;"><span>├─ requirements.txt
</span></span><span style="display:flex;"><span>└──app
</span></span><span style="display:flex;"><span>   ├─ main.py
</span></span><span style="display:flex;"><span>   ├─static
</span></span><span style="display:flex;"><span>   │  └─css
</span></span><span style="display:flex;"><span>   │    └── 1.css
</span></span><span style="display:flex;"><span>   └──templates
</span></span><span style="display:flex;"><span>      └── index.html
</span></span></code></pre></div><p>这里有一个潜在的坑, 如果你要在<code>project</code>目录下直接启动服务器的话, 是不能提供<code>app-path</code>的, 而是用通过<code>--root</code>来启动, 比如说<code>adev runserver --root app</code></p>
<p>但是如果你的<code>pwd</code>是<code>app</code>, 此时不需要提供<code>root-path</code>, 只需要提供<code>app-apth</code>, 启动命令变为<code>adev runserver main.py</code></p>
<p>贴一下<code>runserver</code>的 help 信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Usage: adev runserver [OPTIONS] [APP_PATH]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Run a development server for an aiohttp apps.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Takes one argument &#34;app-path&#34; which should be a path to either a directory
</span></span><span style="display:flex;"><span>  containing a recognized default file (&#34;app.py&#34; or &#34;main.py&#34;) or to a
</span></span><span style="display:flex;"><span>  specific file. Defaults to the environment variable &#34;AIO_APP_PATH&#34; or &#34;.&#34;.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  The app path is run directly, see the &#34;--app-factory&#34; option for details
</span></span><span style="display:flex;"><span>  on how an app is loaded from a python module.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>  -s, --static DIRECTORY          Path of static files to serve, if excluded
</span></span><span style="display:flex;"><span>                                  static files aren&#39;t served. env variable:
</span></span><span style="display:flex;"><span>                                  AIO_STATIC_STATIC
</span></span><span style="display:flex;"><span>  --root DIRECTORY                Root directory project used to qualify other
</span></span><span style="display:flex;"><span>                                  paths. env variable: AIO_ROOT
</span></span><span style="display:flex;"><span>  --static-url TEXT               URL path to serve static files from, default
</span></span><span style="display:flex;"><span>                                  &#34;/static/&#34;. env variable: AIO_STATIC_URL
</span></span><span style="display:flex;"><span>  --livereload / --no-livereload  Whether to inject livereload.js into html
</span></span><span style="display:flex;"><span>                                  page footers to autoreload on changes. env
</span></span><span style="display:flex;"><span>                                  variable AIO_LIVERELOAD
</span></span><span style="display:flex;"><span>  --host TEXT                     host used when referencing livereload and
</span></span><span style="display:flex;"><span>                                  static files, if blank host is taken from
</span></span><span style="display:flex;"><span>                                  the request header with default of
</span></span><span style="display:flex;"><span>                                  localhost. env variable AIO_HOST
</span></span><span style="display:flex;"><span>  --debug-toolbar / --no-debug-toolbar
</span></span><span style="display:flex;"><span>                                  Whether to enable debug toolbar. env
</span></span><span style="display:flex;"><span>                                  variable: AIO_DEBUG_TOOLBAR
</span></span><span style="display:flex;"><span>  --app-factory TEXT              name of the app factory to create an
</span></span><span style="display:flex;"><span>                                  aiohttp.web.Application with, if missing
</span></span><span style="display:flex;"><span>                                  default app-factory names are tried. This
</span></span><span style="display:flex;"><span>                                  can be either a function with signature &#34;def
</span></span><span style="display:flex;"><span>                                  create_app(loop): -&gt; Application&#34; or &#34;def
</span></span><span style="display:flex;"><span>                                  create_app(): -&gt; Application&#34; or just an
</span></span><span style="display:flex;"><span>                                  instance of aiohttp.Application. env
</span></span><span style="display:flex;"><span>                                  variable AIO_APP_FACTORY
</span></span><span style="display:flex;"><span>  -p, --port INTEGER              Port to serve app from, default 8000. env
</span></span><span style="display:flex;"><span>                                  variable: AIO_PORT
</span></span><span style="display:flex;"><span>  --aux-port INTEGER              Port to serve auxiliary app (reload and
</span></span><span style="display:flex;"><span>                                  static) on, default port + 1. env variable:
</span></span><span style="display:flex;"><span>                                  AIO_AUX_PORT
</span></span><span style="display:flex;"><span>  -v, --verbose                   Enable verbose output.
</span></span><span style="display:flex;"><span>  --help                          Show this message and exit.
</span></span></code></pre></div><p>其中, <code>-s, --static</code>因为实际上静态文件要通过<code>--aux-port</code>去访问, 所以感觉有些鸡肋.</p>
<p>也就是说, 如果正常的服务器启动在<code>6001</code>端口, 而<code>aux-server</code>启动在<code>6002</code>端口, 我们要使用这个参数代理的静态文件的话, 要访问<code>http://localhost:6002/static/1.css</code>, 而正常我们会把静态文件放在同一个域名下, 也就是<code>http://localhost:6001/static/1.css</code>, 所以我的选择是直接添加一个<code>web.static</code>的路由, 而不是使用的这个功能.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.trim21.me/tags/python/">python</a></li>
    </ul>
  </footer><script src="https://utteranc.es/client.js"
    repo="trim21/blog"
    issue-term="title"
    theme="github-dark"
    crossorigin="anonymous"
    async></script>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://blog.trim21.me/">Trim21&#39;s</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
